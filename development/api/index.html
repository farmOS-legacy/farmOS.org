<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://farmos.org/development/api/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>API - farmOS.org</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/atelier-dune-light.min.css">
        <link href="../../extra.css" rel="stylesheet">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-56974603-1', 'farmos.org');
            ga('send', 'pageview');
        </script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">farmOS.org</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">User Guide <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../guide/" class="dropdown-item">Introduction</a>
</li>
                                    
<li>
    <a href="../../guide/app/" class="dropdown-item">Field Kit</a>
</li>
                                    
<li>
    <a href="../../guide/areas/" class="dropdown-item">Mapping your farm</a>
</li>
                                    
<li>
    <a href="../../guide/logs/" class="dropdown-item">Logging events</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Managing assets</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../guide/assets/" class="dropdown-item">Introduction</a>
</li>
            
<li>
    <a href="../../guide/assets/plantings/" class="dropdown-item">Plantings</a>
</li>
            
<li>
    <a href="../../guide/assets/animals/" class="dropdown-item">Animals</a>
</li>
            
<li>
    <a href="../../guide/assets/equipment/" class="dropdown-item">Equipment</a>
</li>
            
<li>
    <a href="../../guide/assets/compost/" class="dropdown-item">Compost</a>
</li>
            
<li>
    <a href="../../guide/assets/sensors/" class="dropdown-item">Sensors</a>
</li>
            
<li>
    <a href="../../guide/assets/groups/" class="dropdown-item">Groups</a>
</li>
    </ul>
  </li>
                                    
<li>
    <a href="../../guide/location/" class="dropdown-item">Movements and location</a>
</li>
                                    
<li>
    <a href="../../guide/quantity/" class="dropdown-item">Quantity measurements</a>
</li>
                                    
<li>
    <a href="../../guide/inventory/" class="dropdown-item">Inventory tracking</a>
</li>
                                    
<li>
    <a href="../../guide/people/" class="dropdown-item">People</a>
</li>
                                    
<li>
    <a href="../../guide/import/" class="dropdown-item">Import</a>
</li>
                                    
<li>
    <a href="../../guide/export/" class="dropdown-item">Export</a>
</li>
                                    
<li>
    <a href="../../guide/quick/" class="dropdown-item">Quick forms</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Community modules</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../guide/contrib/" class="dropdown-item">Introduction</a>
</li>
            
<li>
    <a href="../../guide/contrib/eggs/" class="dropdown-item">Eggs</a>
</li>
            
<li>
    <a href="../../guide/contrib/forest/" class="dropdown-item">Forest</a>
</li>
            
<li>
    <a href="../../guide/contrib/grazing/" class="dropdown-item">Grazing</a>
</li>
            
<li>
    <a href="../../guide/contrib/nutrient/" class="dropdown-item">Nutrient</a>
</li>
            
<li>
    <a href="../../guide/contrib/organic/" class="dropdown-item">Organic</a>
</li>
            
<li>
    <a href="../../guide/contrib/produce-safety/" class="dropdown-item">Produce Safety</a>
</li>
            
<li>
    <a href="../../guide/contrib/quick-weight/" class="dropdown-item">Quick Weight Form</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Hosting <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../hosting/" class="dropdown-item">Getting started</a>
</li>
                                    
<li>
    <a href="../../hosting/installing/" class="dropdown-item">Installing</a>
</li>
                                    
<li>
    <a href="../../hosting/updating/" class="dropdown-item">Updating</a>
</li>
                                    
<li>
    <a href="../../hosting/apikeys/" class="dropdown-item">API Keys</a>
</li>
                                    
<li>
    <a href="../../hosting/docker/" class="dropdown-item">Docker</a>
</li>
                                    
<li>
    <a href="../../hosting/localization/" class="dropdown-item">Localization</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Development <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../drupal/" class="dropdown-item">Drupal</a>
</li>
                                    
<li>
    <a href="../projects/" class="dropdown-item">Projects</a>
</li>
                                    
<li>
    <a href="../architecture/" class="dropdown-item">Architecture</a>
</li>
                                    
<li>
    <a href="../update-safety/" class="dropdown-item">Update Safety</a>
</li>
                                    
<li>
    <a href="../docker/" class="dropdown-item">Docker</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">API</a>
</li>
                                    
<li>
    <a href="../client/" class="dropdown-item">Client</a>
</li>
                                    
<li>
    <a href="../release/" class="dropdown-item">Release procedure</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Community <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../community/contribute/" class="dropdown-item">Contribute</a>
</li>
                                    
<li>
    <a href="../../community/monthly-call/" class="dropdown-item">Monthly Call</a>
</li>
                                    
<li>
    <a href="https://riot.im/app/#/room/#farmOS:matrix.org" class="dropdown-item">Chat</a>
</li>
                                    
<li>
    <a href="https://farmOS.discourse.group/" class="dropdown-item">Forum</a>
</li>
                                    
<li>
    <a href="../../community/farms/" class="dropdown-item">Farms</a>
</li>
                                    
<li>
    <a href="../../community/maintainers/" class="dropdown-item">Maintainers</a>
</li>
                                    
<li>
    <a href="../../community/supporters/" class="dropdown-item">Supporters</a>
</li>
                                    
<li>
    <a href="../../community/press/" class="dropdown-item">Press</a>
</li>
                                    
<li>
    <a href="../../community/trademark/" class="dropdown-item">Trademark</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../faq/" class="nav-link">FAQ</a>
                            </li>
                            <li class="navitem">
                                <a href="../../donate/" class="nav-link">Donate</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../docker/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../client/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/farmOS-legacy/farmOS.org/edit/7.x-1.x/docs/development/api.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#api" class="nav-link">API</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#authentication" class="nav-link">Authentication</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#farmjson" class="nav-link">/farm.json</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#requesting-records" class="nav-link">Requesting records</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#creating-records" class="nav-link">Creating records</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#updating-records" class="nav-link">Updating records</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#field-collections" class="nav-link">Field collections</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#uploading-files" class="nav-link">Uploading files</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#oauth2-details" class="nav-link">OAuth2 Details</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#troubleshooting" class="nav-link">Troubleshooting</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="api">API<a class="headerlink" href="#api" title="Permanent link">&para;</a></h1>
<p>farmOS has a <a href="https://en.wikipedia.org/wiki/Representational_state_transfer">REST API</a> that other applications/systems can use to communicate
with farmOS programatically. The API provides <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD</a> operations for all of the
main farmOS <a href="/development/architecture">record types</a> (Drupal entity types). This is accomplished with the
<a href="https://www.drupal.org/project/restws">RESTful Web Services</a> module.</p>
<p><strong>Note for Sensor Data:</strong> If you are looking for documentation about pushing
and pulling data from sensors in farmOS, see <a href="/guide/assets/sensors">Sensors</a>.</p>
<p>The following documentation provides a brief overview of the farmOS API for
developers who are interested in using it. For more general information, please
refer to the <a href="https://www.drupal.org/node/1860564">RESTful Web Services module documentation</a>.</p>
<p>In all of the commands below, replace the following placeholders with your
specific farmOS URL, username, and password.</p>
<ul>
<li><code>[URL]</code> - Base URL of the farmOS instance, without trailing slash (eg: <code>https://example.farmos.net</code>)</li>
<li><code>[USER]</code> - User name (eg: <code>MyUserName</code>)</li>
<li><code>[PASS]</code> - Password (eg: <code>MyPassword</code>)</li>
<li><code>[AUTH]</code> - Authentication parameters for <code>curl</code> commands (this will depend on
  the authentication method you choose below).</li>
</ul>
<h2 id="authentication">Authentication<a class="headerlink" href="#authentication" title="Permanent link">&para;</a></h2>
<p>There are three ways to authenticate with a farmOS server:</p>
<ol>
<li>OAuth2 Authorization Tokens (recommended)</li>
<li>Session Cookie and CSRF Token</li>
<li>Basic Authentication</li>
</ol>
<h3 id="1-oauth2-authorization-tokens">1. OAuth2 Authorization Tokens<a class="headerlink" href="#1-oauth2-authorization-tokens" title="Permanent link">&para;</a></h3>
<p>farmOS includes an OAuth2 Authorization server for providing 3rd party clients 
access to the farmOS API. Rather than using a user's username and password to
authenticate, OAuth2 uses access tokens to authenticate users. The access tokens
are provided to both 1st and 3rd party clients who wish to access a user's 
protected resources from a server. Clients store the access token instead of the
user's credentials, which makes it a more secure authentication method.</p>
<p>Read more about the <a href="https://oauth.net/2/">OAuth 2.0 standards</a></p>
<p>For more information about authenticating with OAuth2, see the
<a href="#oauth2-details">OAuth2 Details</a> section below.</p>
<p>Once you have an OAuth2 token, you can pass it to farmOS with an
<code>Authorization: Bearer</code> header.</p>
<pre><code>-H "Authorization: Bearer [OAUTH-TOKEN]"
</code></pre>
<p>This should be used to replace <code>[AUTH]</code> in the <code>curl</code> examples that follow.</p>
<h3 id="2-session-cookie-and-csrf-token">2. Session Cookie and CSRF Token<a class="headerlink" href="#2-session-cookie-and-csrf-token" title="Permanent link">&para;</a></h3>
<p>The old approach (before OAuth2 was introduced in farmOS 7.x-1.4), was to
authenticate via Drupal's <code>user_login</code> form and save the session cookie provided
by Drupal. Then, you can use that to retrieve a CSRF token from
<code>[URL]/restws/session/token</code>, which is provided and required by the <code>restws</code>
module. The cookie and token can then be included with each API request.</p>
<p>The following <code>curl</code> command will authenticate using the username and password,
and save the session cookie to a file called <code>farmOS-cookie.txt</code>. Then it will
get a session token and save that to a <code>$TOKEN</code> variable. Together, the cookie
and token can be used to make authenticated requests.</p>
<pre><code>curl --cookie-jar farmOS-cookie.txt -d 'name=[USER]&amp;pass=[PASS]&amp;form_id=user_login' [URL]/user/login
TOKEN="$(curl --cookie farmOS-cookie.txt [URL]/restws/session/token)"
</code></pre>
<p>After running those two commands, the cookie and token can be included with
subsequent <code>curl</code> requests via the <code>--cookie</code> and <code>-H</code> parameters:</p>
<pre><code>--cookie farmOS-cookie.txt -H "X-CSRF-Token: ${TOKEN}"
</code></pre>
<p>This should be used to replace <code>[AUTH]</code> in the <code>curl</code> examples that follow.</p>
<h3 id="3-basic-authentication">3. Basic Authentication<a class="headerlink" href="#3-basic-authentication" title="Permanent link">&para;</a></h3>
<p>An alternative approach is to use <a href="https://en.wikipedia.org/wiki/Basic_access_authentication">HTTP Basic Authentication</a>.</p>
<p>The RESTful Web Services module comes with a Basic Authentication sub-module,
which provides the ability to include the username and password with each
request using HTTP Basic Authentication. This modules is included with farmOS
but is disabled by default.</p>
<p><strong>By default the module only tries to authenticate usernames prefixed with 'restws'.</strong>
This can be changed by modifying the regex used against usernames - see the
<a href="https://cgit.drupalcode.org/restws/tree/restws_basic_auth/README.txt">RESTful Web Services Basic Authentication module documentation</a>.</p>
<p><strong>SSL encryption is highly recommended.</strong> This option requires sending
credentials with every request which means extra care must be taken to not
expose these credentials. Using SSL will encrypt the credentials with each
request. Otherwise, they will be sent in plaintext.</p>
<p>Using basic authentication makes it much easier to test the API with
development tools such as <a href="https://www.getpostman.com/">Postman</a> or <a href="https://restlet.com/">Restlet</a>. You just need to add basic
authentication credentials to the request header. The request returns a cookie,
which seems to be saved by these applications. This means subsequent requests
don't need the authentication header, as long as the cookie is saved.</p>
<p>Basic Authentication can be used in <code>curl</code> requests via the <code>-u</code> parameter:</p>
<pre><code>-u [USER]:[PASS]
</code></pre>
<p>This should be used to replace <code>[AUTH]</code> in the <code>curl</code> examples that follow.</p>
<h2 id="farmjson">/farm.json<a class="headerlink" href="#farmjson" title="Permanent link">&para;</a></h2>
<p>farmOS provides an informational API endpoint at <code>/farm.json</code>, which includes
the farm name, URL, API version, the system of measurement used by the farm,
information about the currently authenticated user, installed languages, and
information about available entity types and bundles.</p>
<p>For example:</p>
<pre><code>{
  "name": "My Farm",
  "url": "https://myfarm.mydomain.com",
  "api_version": "1.0",
  "system_of_measurement": "metric",
  "user": {
    "uid": "3",
    "name": "My Username",
    "mail": "myemail@mydomain.com",
    "language": "en",
  },
  "languages": {
    "en": {
      "language": "en",
      "name": "English",
      "native": "English",
      "direction": 0,
    },
  },
  "resources": {
    "log": {
      "farm_activity": {
        "label": "Activity",
        "label_plural": "Activities",
        "fields" {
          "area": {
            "label": "Areas",
            "type": "taxonomy_term_reference",
            "required": 0,
          },
          ...
        },
      }
    },
    ...
  }
}
</code></pre>
<p>The <code>system_of_measurement</code> with be either <code>metric</code> or <code>us</code>.</p>
<p>The <code>resources</code> section contains a list of entity types (aka "resource types")
that are available. Within each is a list of bundles (eg: "log types", "asset
types", etc). Each bundle contains information such as its translated <code>label</code>,
and a list of available <code>fields</code> and their metadata (<code>label</code>, <code>required</code>, etc).
The <code>taxonomy_term</code> bundles also contain their <code>vid</code> (vocabulary ID), which is
necessary when creating new terms (see <a href="#creating-taxonomy-terms">Creating taxonomy terms</a>).</p>
<p>Other modules can add information to <code>/farm.json</code> with <code>hook_farm_info()</code>.</p>
<h3 id="api-version">API Version<a class="headerlink" href="#api-version" title="Permanent link">&para;</a></h3>
<p><strong>Current API version: 1.3</strong></p>
<p>It is <em>highly</em> recommended that you check the API version of the farmOS system
you are communicating with, to be sure that your code is using the same version.
If any changes are made that are not backwards compatible, the API version will
change. So by checking it in your code, you can prevent unexpected things from
happening if you try to use unsupported API features.</p>
<h2 id="requesting-records">Requesting records<a class="headerlink" href="#requesting-records" title="Permanent link">&para;</a></h2>
<p>The following <code>curl</code> command examples demonstrate how to get lists of records
and individual records in JSON format. They use the stored <code>farmOS-cookie.txt</code>
file and <code>$TOKEN</code> variable generated with the commands above.</p>
<p><strong>Lists of records</strong></p>
<p>This will retrieve a list of harvest logs in JSON format:</p>
<pre><code>curl [AUTH] [URL]/log.json?type=farm_harvest
</code></pre>
<p>Records can also be requested in XML format by changing the file extension in
the URL:</p>
<pre><code>curl [AUTH] [URL]/log.xml?type=farm_harvest
</code></pre>
<p><strong>Individual records</strong></p>
<p>Individual records can be retrieved in a similar way, by including their entity
ID. This will retrieve a log with ID 1:</p>
<pre><code>curl [AUTH] [URL]/log/1.json
</code></pre>
<p><strong>Endpoints</strong></p>
<p>The endpoint to use depends on the entity type you are requesting:</p>
<ul>
<li>Assets: <code>/farm_asset.json</code><ul>
<li>Plantings: <code>/farm_asset.json?type=planting</code></li>
<li>Animals: <code>/farm_asset.json?type=animal</code></li>
<li>Equipment: <code>/farm_asset.json?type=equipment</code></li>
<li>...</li>
</ul>
</li>
<li>Logs: <code>/log.json</code><ul>
<li>Activities: <code>/log.json?type=farm_activity</code></li>
<li>Observations: <code>/log.json?type=farm_observation</code></li>
<li>Harvests: <code>/log.json?type=farm_harvest</code></li>
<li>Inputs: <code>/log.json?type=farm_input</code></li>
<li>...</li>
</ul>
</li>
<li>Taxonomy terms: <code>/taxonomy_term.json</code><ul>
<li>Areas&ast;: <code>/taxonomy_term.json?bundle=farm_areas</code></li>
<li>Quantity Units: <code>/taxonomy_term.json?bundle=farm_quantity_units</code></li>
<li>Crops/varieties: <code>/taxonomy_term.json?bundle=farm_crops</code></li>
<li>Animal species/breeds: <code>/taxonomy_term.json?bundle=farm_animal_types</code></li>
<li>Log categories: <code>/taxonomy_term.json?bundle=farm_log_categories</code></li>
<li>Seasons: <code>/taxonomy_term.json?bundle=farm_season</code></li>
<li>...</li>
</ul>
</li>
</ul>
<p>&ast; Note that areas are currently represented as Drupal taxonomy terms, but may be
changed to assets in the future. See <a href="https://www.drupal.org/project/farm/issues/2363393">Make "Area" into a type of Farm Asset</a>.</p>
<p><strong>Filtering</strong></p>
<p>Filters can be applied via query parameters tacked on to the end of the URL. For
example, to show only "done" logs:</p>
<pre><code>/log.json?done=1
</code></pre>
<p>Refer to lists of fields under "Creating records" below for available filters.</p>
<p>When a record references other records (for example, a log that references an
asset), you must filter by the referenced record's ID. For example, to find logs
that reference asset ID 5:</p>
<pre><code>/log.json?asset=5
</code></pre>
<p>Taxonomy term references are an exception to this rule. It is possible to filter
using the name of the term, rather than the ID. For example, to show logs with
a category of "Tillage":</p>
<pre><code>/log.json?log_category=Tillage
</code></pre>
<p>The term name is also included in the returned JSON structure, alongside the
term ID, so that extra requests to look up term names are not necessary.</p>
<h2 id="creating-records">Creating records<a class="headerlink" href="#creating-records" title="Permanent link">&para;</a></h2>
<p>Records can be created with a <code>POST</code> request of JSON/XML objects to the endpoint
for the entity type you would like to create.</p>
<h3 id="creating-logs">Creating logs<a class="headerlink" href="#creating-logs" title="Permanent link">&para;</a></h3>
<p>First, here is a very simple example of an observation log in JSON. The bare
minimum required fields are <code>name</code>, <code>type</code>, and <code>timestamp</code>.</p>
<pre><code>{
  "name": "Test observation via REST",
  "type": "farm_observation",
  "timestamp": "1526584271",
}
</code></pre>
<p>Here is a <code>curl</code> command to create that log in farmOS:</p>
<pre><code>curl -X POST [AUTH] -H 'Content-Type: application/json' -d '{"name": "Test observation via REST", "type": "farm_observation", "timestamp": "1526584271"}' [URL]/log
</code></pre>
<p>Most log types have the same set of standard fields. Some specific log types
differ slightly. The following are standard fields available on most log types:</p>
<ul>
<li><code>id</code>: The log ID (unique database primary key).</li>
<li><code>name</code>: The log name.</li>
<li><code>type</code>: The log type. Some types that are included in farmOS are:<ul>
<li><code>farm_activity</code>: General activity logs.</li>
<li><code>farm_observation</code>: General observation logs.</li>
<li><code>farm_input</code>: An input to one or more assets/areas.</li>
<li><code>farm_harvest</code>: A harvest from one or more assets/areas.</li>
<li><code>farm_seeding</code>: A seeding log (specific to Planting assets).</li>
<li><code>farm_transplanting</code>: A transplanting log (specific to Planting assets).</li>
<li><code>farm_maintenance</code>: A maintenance log (specific to Equipment assets).</li>
</ul>
</li>
<li><code>timestamp</code>: A timestamp representing when the logged event took place.</li>
<li><code>done</code>: Boolean value indicating whether the log is "done" or not.</li>
<li><code>notes</code>: A free-form text field for log notes.<ul>
<li>Note that this should be a JSON object with a <code>value</code> property and a
  <code>format</code> property set to <code>farm_format</code>.</li>
</ul>
</li>
<li><code>asset</code>: Reference(s) to asset(s) that the log is associated with.</li>
<li><code>equipment</code>: Reference(s) to equipment assets that were used in the process.</li>
<li><code>area</code>: Reference(s) to area(s) that the log is associated with.</li>
<li><code>geofield</code>: Geometry specific to the logged event.</li>
<li><code>movement</code>: Movement information (see "Field collections" below).</li>
<li><code>membership</code>: Group membership information (see "Field collections" below).</li>
<li><code>quantity</code>: Quantity measurements (see "Field collections" below).</li>
<li><code>images</code>: Image files attached to the log.</li>
<li><code>files</code>: Other files attached to the log.</li>
<li><code>flags</code>: Flags associated with the log. Examples:<ul>
<li><code>priority</code></li>
<li><code>monitor</code></li>
<li><code>review</code></li>
</ul>
</li>
<li><code>log_category</code>: A reference to one or more log categories.</li>
<li><code>log_owner</code>: A reference to one or more users that the log is assigned to.<ul>
<li>Note that this is different from <code>uid</code>, which is the user who created the
  log.</li>
</ul>
</li>
<li><code>created</code>: A timestamp representing when the log was created.</li>
<li><code>changed</code>: A timestamp representing when the log was last updated.</li>
<li><code>uid</code>: A reference to the user who created the log.</li>
<li><code>data</code>: An arbitrary string of data. This can be used to store additional data
  on the log as JSON, XML, YAML, etc. <strong>It is the resposibility of the API user
  to respect data format that is already in the log.</strong></li>
</ul>
<h4 id="input-logs">Input logs<a class="headerlink" href="#input-logs" title="Permanent link">&para;</a></h4>
<p>Additional fields on input logs (all optional):</p>
<ul>
<li><code>material</code>: Reference(s) to material(s) that were applied.</li>
<li><code>input_purpose</code>: A description of the purpose of the input.</li>
<li><code>input_method</code>: A description of how the input was applied.</li>
<li><code>input_source</code>: A description of where the input was obtained.</li>
<li><code>date_purchase</code>: A timestamp representing when the input material was
  purchased.</li>
<li><code>lot_number</code>: The lot number(s) of the input material, if available.</li>
</ul>
<h4 id="harvest-logs">Harvest logs<a class="headerlink" href="#harvest-logs" title="Permanent link">&para;</a></h4>
<p>Additional fields on harvest logs (all optional):</p>
<ul>
<li><code>lot_number</code>: The harvest lot number.</li>
</ul>
<h4 id="seeding-and-transplanting-logs">Seeding and transplanting logs<a class="headerlink" href="#seeding-and-transplanting-logs" title="Permanent link">&para;</a></h4>
<p>Seeding and transplanting logs are log types that are specific to Planting
assets (to indicate when seedings/transplantings took place, along with quantity
and location information). They have some key differences from other log types:</p>
<ul>
<li>The <code>asset</code> field is required and must reference an asset of type <code>planting</code>.</li>
<li>They do not have the <code>areas</code> or <code>geofield</code> fields, and instead expect to have
  a <code>movement</code> field collection with information about where it took place. This
  is used to set the location of the planting at a given point in time.</li>
<li>Seeding logs also have a <code>seed_source</code> field which can be used to specify
  where seeds came from (free-form text field).</li>
</ul>
<h3 id="creating-assets">Creating assets<a class="headerlink" href="#creating-assets" title="Permanent link">&para;</a></h3>
<p>Assets must have a <code>name</code> and a <code>type</code>, and some asset types have additional
required fields. For example <code>planting</code> assets require a <code>crop</code> reference (for
crop/variety), <code>animal</code> assets require an <code>animal_type</code> reference (for
species/breed), and other types may have other requirements. A quick way to find
out which fields are required is to open the "Add asset" form in farmOS and look
for the red asterisk that indicates a required field.</p>
<p>A very basic "Equipment" asset looks like this:</p>
<pre><code>{
  "name": "Tractor",
  "type": "equipment",
  "manufacturer": "Allis-Chambers",
  "model": "G",
  "serial_number": "1234567890",
}
</code></pre>
<p>Here is a <code>curl</code> command to create that asset in farmOS:</p>
<pre><code>curl -X POST [AUTH] -H 'Content-Type: application/json' -d '{"name": "Tractor", "type": "equipment", "manufacturer": "Allis-Chambers", "model": "G", "serial_number": "1234567890"}' [URL]/farm_asset
</code></pre>
<p>Most asset types have the same set of standard fields. Some specific asset types
differ slightly. The following are standard fields available on most log types:</p>
<ul>
<li><code>id</code>: The asset ID (unique database primary key).</li>
<li><code>name</code>: The asset name.</li>
<li><code>type</code>: The asset type. Some types that are included in farmOS are:<ul>
<li><code>planting</code></li>
<li><code>animal</code></li>
<li><code>equipment</code></li>
<li><code>group</code></li>
</ul>
</li>
<li><code>description</code>: A free-form text field for an asset description.<ul>
<li>Note that this should be a JSON object with a <code>value</code> property and a
  <code>format</code> property set to <code>farm_format</code>.</li>
</ul>
</li>
<li><code>archived</code>: A timestamp representing when the asset was archived. If this is
  <code>0</code> then the asset is not archived.</li>
<li><code>images</code>: Image files attached to the asset.</li>
<li><code>files</code>: Other files attached to the asset.</li>
<li><code>flags</code>: Flags associated with the log. Examples:<ul>
<li><code>priority</code></li>
<li><code>monitor</code></li>
<li><code>review</code></li>
</ul>
</li>
<li><code>created</code>: A timestamp representing when the asset was created.</li>
<li><code>changed</code>: A timestamp representing when the asset was last changed.</li>
<li><code>uid</code>: A reference to the user who created the asset.</li>
<li><code>data</code>: An arbitrary string of data. This can be used to store additional data
  on the asset as JSON, XML, YAML, etc. <strong>It is the resposibility of the API
  user to respect data format that is already in the log.</strong></li>
</ul>
<p>Assets will also have the following special-purpose fields, which are computed
based on the asset's log history. These fields cannot be written to directly,
they can only be changed via logs.</p>
<ul>
<li><code>location</code>: An array of references to areas that the asset is currently
  located in, based on its most recent completed movement log.</li>
<li><code>geometry</code>: The current geometry of the asset, based on its most recent
  completed movement log.</li>
</ul>
<h4 id="planting-assets">Planting assets<a class="headerlink" href="#planting-assets" title="Permanent link">&para;</a></h4>
<p>Additional fields on animal assets:</p>
<ul>
<li><code>crop</code>: Reference(s) to the crops/varieties this is a planting of.
   <strong>Required.</strong></li>
<li><code>parent</code>: Reference(s) to assets that this planting is derived from.</li>
</ul>
<h4 id="animal-assets">Animal assets<a class="headerlink" href="#animal-assets" title="Permanent link">&para;</a></h4>
<p>Additional fields on animal assets:</p>
<ul>
<li><code>animal_type</code>: Reference to the animal's species/breed. <strong>Required.</strong></li>
<li><code>animal_nicknames</code>: Nickname(s) for the animal.</li>
<li><code>animal_castrated</code>: Boolean indicating whether or not this animal has been
  castrated.</li>
<li><code>animal_sex</code>: The sex of the animal. Available options:<ul>
<li><code>F</code> (female)</li>
<li><code>M</code> (male)</li>
</ul>
</li>
<li><code>tag</code>: ID Tag(s) that are assigned to the animal (see "Field collections"
  below).</li>
<li><code>parent</code>: Reference(s) to the animal's parent(s).</li>
<li><code>date</code>: A timestamp representing the birth date of the animal.</li>
</ul>
<h4 id="equipment-assets">Equipment assets<a class="headerlink" href="#equipment-assets" title="Permanent link">&para;</a></h4>
<p>Additional fields on equipment assets (all optional):</p>
<ul>
<li><code>manufacturer</code>: The equipment manufacturer.</li>
<li><code>model</code>: The equipment model.</li>
<li><code>serial_number</code>: The equipment serial number.</li>
</ul>
<h3 id="creating-taxonomy-terms">Creating taxonomy terms<a class="headerlink" href="#creating-taxonomy-terms" title="Permanent link">&para;</a></h3>
<p>farmOS allows farmers to build vocabularies of terms for various categorization
purposes. These are referred to as "taxonomies" in farmOS (and Drupal), although
"vocabulary" is sometimes used interchangeably.</p>
<p>Some things that are represented as taxonomy terms include quantity units,
crops/varieties, animal species/breeds, input materials, and log categories.
See "Endpoints" above for specific API endpoints URLs.</p>
<p>A very basic taxonomy term JSON structure looks like this:</p>
<pre><code>{
  "tid": "3",
  "name": "Cabbage",
  "description": "",
  "vocabulary": {
    "id": "7",
    "resource": "taxonomy_vocabulary",
  },
  "parent": [
    {
      "id": "10",
      "resource": "taxonomy_term",
    },
  ],
  "weight": "5",
}
</code></pre>
<p>The <code>tid</code> is the unique ID of the term (database primary key). When creating a
new term, the only required fields are <code>name</code> and <code>vocabulary</code>. The vocabulary
is an ID that corresponds to the specific vocabulary the term will be a part of
(eg: quantity units, crops/varieties, log categories, etc). The fields <code>parent</code>
and <code>weight</code> control term hierarchy and ordering (a heavier <code>weight</code> will sort
it lower in the list).</p>
<p>When fetching a list of terms from farmOS, you can filter by the vocabulary's
"machine name" (or "bundle") like so:</p>
<pre><code>curl [AUTH] [URL]/taxonomy_term.json?bundle=farm_crops
</code></pre>
<p>When creating a new term, however, you need to provide the vocabulary ID in the
term object, not the machine name/bundle. In order to get the vocabulary ID, you
can look it up using the <code>/taxonomy_vocabulary</code> endpoint, which lists all
available vocabularies. Or, you can find it in <code>farm.json</code> (described above).</p>
<p>The vocabulary ID may be different from one farmOS system to another, so if you
save it internally in your application, just know that it may not correspond to
the same vocabulary on another farmOS. Therefore it is recommended that you look
it up each time you need it.</p>
<p>For example, to get the <code>vid</code> that corresponds to the <code>farm_crops</code> vocabulary:</p>
<pre><code>curl [AUTH] [URL]/taxonomy_vocabulary.json?machine_name=farm_crops
</code></pre>
<p>Or, by loading the information in <code>farm.json</code> and parsing out the vocabulary ID:</p>
<pre><code>curl [AUTH] [URL]/farm.json
</code></pre>
<p>Before you create a new term, you should check to see if it already exists:</p>
<pre><code>curl [AUTH] [URL]/taxonomy_term.json?bundle=farm_crops&amp;name=Broccoli
</code></pre>
<p>Then, you can create a new term (replace <code>[VID]</code> with the ID of the vocabulary
the term should be added to):</p>
<pre><code>curl [AUTH] -X POST -H 'Content-Type: application/json' -d '{"name": "Broccoli", "vocabulary": "[VID]"}' [URL]/taxonomy_term
</code></pre>
<p>For convenience, it is possible to create terms on-the-fly when creating or 
updating other records that reference them. Simply provide the <code>name</code> of the
term instead of the <code>tid</code>, and farmOS will attempt to look up the existing term,
or create a new one.</p>
<p>For example, to create a "2020 Spinach" planting asset, a "Spinach" crop term,
and a "2020" season term all at the same time:</p>
<pre><code>{
  "name": "2020 Spinach",
  "type": "planting",
  "crop": [{"name": "Spinach"}],
  "season": [{"name": "2020"}],
}
</code></pre>
<p><strong>Creating an area</strong></p>
<p>Areas are taxonomy terms in farmOS, but they have some additional fields on them
for mapping purposes. In order for an area to show up on a map, it must have an
<code>area_type</code> set, and a geometry in the <code>geofield</code>.</p>
<p>A very basic area record looks like this:</p>
<pre><code>{
  "name": "North field",
  "description": "",
  "area_type": "field",
  "geofield": [
    {
      "geom": "POINT(-31.04003861546518 39.592143995003994)",
    },
  ],
}
</code></pre>
<p>The geometry should be in <a href="https://en.wikipedia.org/wiki/Well-known_text_representation_of_geometry">Well-Known Text</a>.</p>
<p>Some available area types include:</p>
<ul>
<li><code>field</code></li>
<li><code>bed</code></li>
<li><code>building</code></li>
<li><code>greenhouse</code></li>
<li><code>property</code></li>
<li><code>paddock</code></li>
<li><code>water</code></li>
<li><code>landmark</code></li>
<li><code>other</code></li>
</ul>
<p>Note that area types are defined by modules (eg: <code>paddock</code> is provided by the
<code>farm_livestock</code> module), so the area types available on your farmOS may vary.</p>
<p>You can fetch all areas of a particular type (eg: <code>field</code>) like this:</p>
<pre><code>curl [AUTH] [URL]/taxonomy_term.json?bundle=farm_areas&amp;area_type=field
</code></pre>
<h2 id="updating-records">Updating records<a class="headerlink" href="#updating-records" title="Permanent link">&para;</a></h2>
<p>Records can be updated with a <code>PUT</code> request of JSON/XML objects to the record's
endpoint (with ID). Only include the fields you want to update - everything
else will be left unchanged.</p>
<p>Do not add <code>.json</code> or <code>.xml</code> to the endpoint's URL. Instead, add a
<code>Content-Type</code> header that specifies either <code>application/json</code> or
<code>application/xml</code>.</p>
<p>For example, to change the name of log 1:</p>
<pre><code>curl -X PUT [AUTH] -H 'Content-Type: application/json' -d '{"name": "Change the log name"}' [URL]/log/1
</code></pre>
<p>Areas will also have the following special-purpose fields, which are computed
based on log history. These fields cannot be written to directly, they can only
be changed via logs.</p>
<ul>
<li><code>assets</code>: An array of references to assets that are currently located in the
  area, based on asset movement logs.</li>
</ul>
<h2 id="field-collections">Field collections<a class="headerlink" href="#field-collections" title="Permanent link">&para;</a></h2>
<p>Some fields are stored within <a href="https://drupal.org/project/field_collection">Field Collections</a> in farmOS, which are
technically separate entities attached to the host entity. farmOS uses the
<a href="https://drupal.org/project/restws_field_collection">RESTful Web Services Field Collection</a> module to hide the fact that these are
separate entities, so that their fields can be accessed and modified in the
same request as the host entity.</p>
<p>In farmOS Field Collections are used for the following:</p>
<h3 id="quantity-measurements">Quantity measurements<a class="headerlink" href="#quantity-measurements" title="Permanent link">&para;</a></h3>
<p><a href="/guide/quantity">Quantity</a> measurements are recorded on logs, and can each include a measure
(eg: count, weight, volume, etc), a value (decimal number), a unit (a reference
to a Units taxonomy term, and a label (a free-form text field).</p>
<p>A log with a quantity measurement looks like this:</p>
<pre><code>{
  "name": "Example quantity measurement log",
  "type": "farm_observation",
  "timestamp": "1551983893",
  "quantity": [
    {
      "measure": "weight",
      "value": "100",
      "unit": {"id": "15"},
      "label": "My label",
    },
  ],
}
</code></pre>
<p>Available <code>measure</code> options are:</p>
<ul>
<li><code>count</code></li>
<li><code>length</code></li>
<li><code>weight</code></li>
<li><code>area</code></li>
<li><code>volume</code></li>
<li><code>time</code></li>
<li><code>temperature</code></li>
<li><code>value</code></li>
<li><code>rate</code></li>
<li><code>rating</code></li>
<li><code>ratio</code></li>
<li><code>probability</code></li>
</ul>
<p>All measurement properties are optional. The label is useful if you have more
than one measurement of the same measure (eg: two weight measurements) in the
same log. Use the label to add more specific information about what each
measurement is for.</p>
<h3 id="movements">Movements<a class="headerlink" href="#movements" title="Permanent link">&para;</a></h3>
<p><a href="/guide/location">Movements</a> are defined on logs, and include an area reference (where the
asset(s) are moving to), and optionally a geometry (if you need to define a more
specific location than the area reference itself).</p>
<p>A log with a movement looks like this:</p>
<pre><code>{
  "name": "Example movement log",
  "type": "farm_activity",
  "timestamp": "1551983893",
  "asset": [
    {"id": "123"},
  ],
  "movement": {
    "area": [
      {"id": "5"},
    ],
    "geometry": "POINT(-31.04003861546518 39.592143995003994)",
  },
}
</code></pre>
<p>Within the <code>movement</code> structure, the area ID should be an area term ID (<code>tid</code> on
the area object). The geometry should be in <a href="https://en.wikipedia.org/wiki/Well-known_text_representation_of_geometry">Well-Known Text</a>. It is possible to
reference multiple areas, indicating that the asset is moved to multiple areas
(eg: a planting in multiple beds).</p>
<h3 id="group-membership">Group membership<a class="headerlink" href="#group-membership" title="Permanent link">&para;</a></h3>
<p><a href="/guide/assets/groups">Group</a> membership changes are defined on logs, and include one or more group
asset IDs. This indicates that any referenced asset(s) were moved to the
group(s) specified at the time of the log.</p>
<p>A log with a group membership change looks like this:</p>
<pre><code>{
  "name": "Example group membership change log",
  "type": "farm_activity",
  "timestamp": "1551983893",
  "asset": [
    {"id": "123"},
  ],
  "membership": {
    "group": [
      {"id": "456"},
    ],
  },
}
</code></pre>
<p>Groups are a type of asset in farmOS, so the group ID is actually an asset ID.</p>
<h3 id="inventory-adjustments">Inventory adjustments<a class="headerlink" href="#inventory-adjustments" title="Permanent link">&para;</a></h3>
<p><a href="/guide/inventory">Inventory</a> adjustments are defined on logs, and include one or more pairs of
asset IDs (the asset for which inventory is being adjusted) and an adjustment
value (postitive or negative number, to indicate an increase or decrease in the
inventory level).</p>
<p>A log with an inventory adjustment looks like this:</p>
<pre><code>{
  "name": "Example group membership change log",
  "type": "farm_activity",
  "timestamp": "1551983893",
  "inventory": [
    {
      "asset": {"id": "123"},
      "value": "-10",
    },
  ],
}
</code></pre>
<h3 id="animal-id-tags">Animal ID Tags<a class="headerlink" href="#animal-id-tags" title="Permanent link">&para;</a></h3>
<p>Animal ID Tags can be added to <a href="/guide/assets/animals">animal</a> assets, and include a Tag ID, Tag Type,
and Tag Location.</p>
<p>An animal asset with an ID tag looks like this:</p>
<pre><code>{
  "name": "Betsy",
  "type": "animal",
  "animal_type": {"id": "10"},
  "tag": [
    {
      "id": "123456",
      "location": "Left ear",
      "type": "Ear tag",
    },
  ],
}
</code></pre>
<p>The ID and Location fields can be anything you want.</p>
<p>Available tag types are:</p>
<ul>
<li><code>Brand</code></li>
<li><code>Ear tag</code></li>
<li><code>Tattoo</code></li>
<li><code>Leg band</code></li>
<li><code>Chip</code></li>
<li><code>Other</code></li>
</ul>
<h2 id="uploading-files">Uploading files<a class="headerlink" href="#uploading-files" title="Permanent link">&para;</a></h2>
<p>Files can be attached to records using the API.</p>
<p>Most record types (areas, assets, logs, etc) have both a "Photo(s)" field (for
image files) and a "File(s)" field (for other files). The machine names of
these fields are:</p>
<ul>
<li>Photo(s): <code>images</code></li>
<li>File(s): <code>files</code></li>
</ul>
<p>The API expects an array of base64-encoded strings. Multiple files can be
included in the array.</p>
<p>For example (replace <code>[BASE64_CONTENT]</code> with the base64 encoding of the file):</p>
<pre><code>{
  "name": "Test file upload via REST",
  "type": "farm_observation",
  "timestamp": "1534261642",
  "images": [
    "data:image/jpeg;base64,[BASE64_CONTENT]",
  ],
}
</code></pre>
<p>Here is an example using <code>curl</code> (replace <code>[filename]</code> with the path to the
file). This will create a new observation log with the file attached to the
"Photo(s)" field of the log.</p>
<pre><code># Get the file MIME type.
FILE_MIME=`file -b --mime-type [filename]`

# Encode the file as a base64 string and save it to a variable.
FILE_CONTENT=`base64 [filename]`

# Post a log with the file attached to the photo field.
# &lt;&lt;CURL_DATA is used because base64 encoded files are generally longer
# the max curl argument length. See:
# https://unix.stackexchange.com/questions/174350/curl-argument-list-too-long
curl -X POST [AUTH] -H "Content-Type: application/json" -d @- [URL]/log &lt;&lt;CURL_DATA
{"name": "Test file upload via REST", "type": "farm_observation", "timestamp": "1534261642", "images": ["data:${FILE_MIME};base64,${FILE_CONTENT}"]}
CURL_DATA
</code></pre>
<h2 id="oauth2-details">OAuth2 Details<a class="headerlink" href="#oauth2-details" title="Permanent link">&para;</a></h2>
<p>The following describes more of the details necessary for using OAuth2 for
authentication with a farmOS server.</p>
<h3 id="scopes">Scopes<a class="headerlink" href="#scopes" title="Permanent link">&para;</a></h3>
<p>OAuth Scopes define different levels of permission. Two scopes are included with
farmOS:</p>
<ul>
<li><code>user_access</code>: This allows full user access to the farmOS server. With this
  scope, a third party can do anything the farmOS user account has permission to
  do.</li>
<li><code>farm_info</code>: Allows access to data at <code>/farm.json</code></li>
</ul>
<h3 id="clients">Clients<a class="headerlink" href="#clients" title="Permanent link">&para;</a></h3>
<p>In order to connect to farmOS via OAuth2, there must be a "client" configured on
the server that corresponds to the client that will be making the requests. This
is necessary so that tokens can be revoked from specific clients.</p>
<p>The core <code>farm_api</code> module provides a default client called <code>farm</code>, which
supports the <strong>Password Credentials</strong> and <strong>Refresh Token</strong> grants (more info in
"Authorization Flows" below). If you are writing a custom script that
communicates with farmOS via the API, this is the recommended approach for
authenticating with username and password.</p>
<p>The core <code>farm_api</code> module also comes with a <code>farm_api_development</code> module that
can be enabled for testing different OAuth authorization flows. For the purposes
of documentation, this client is used in below examples. This module defines
an OAuth client with the following parameters:</p>
<ul>
<li><code>client_id</code> = <code>farmos_development</code></li>
<li><code>client_secret</code> = None. This client does not require a <code>client_secret</code></li>
<li><code>redirect_uri</code> = <code>http://localhost/api/authorized</code> (This is required for the
  Authorization Code Grant)</li>
</ul>
<p>A client can be added via a farmOS module by implementing
<code>hook_farm_api_oauth2_client()</code>. The following example defines a client for a
fictional farmOS Aggregator called "My Aggregator":</p>
<pre><code>&lt;?php

/**
 * Implements hook_farm_api_oauth2_client().
 */
function myaggregator_farm_api_oauth2_client() {
  $clients = array();

  // Define an OAuth2 client for My Aggregator.
  $redirect_uris = array(
    'https://myfarmosaggregator.com/register-farm',
    'https://myfarmosaggregator.com/authorize-farm',
  );
  $clients['my_aggregator'] = array(
    'label' =&gt; 'My Aggregator',
    'client_key' =&gt; 'my_farmos_client',
    'redirect_uri' =&gt; implode("\n", $aggregator_redirect_uris),
  );

  return $clients;
}
</code></pre>
<h3 id="authorization-flows">Authorization Flows<a class="headerlink" href="#authorization-flows" title="Permanent link">&para;</a></h3>
<p>The <a href="https://oauth.net/2/">OAuth 2.0 standards</a> outline 5 <a href="https://oauth.net/2/grant-types/">Oauth2 Grant Types</a> to be used in an OAuth2
Authorization Flow - They are the <em>Authorization Code, Implicit, Password
Credentials, Client Credentials</em> and <em>Refresh Token</em> Grants. Currently, the
farmOS OAuth Server only supports the <strong>Authorization Code</strong>,
<strong>Password Credentials</strong> and <strong>Refresh Token</strong> grants. The 
<a href="#authorization-code-grant">Authorization Code</a> and
<a href="#refreshing-tokens">Refresh Token</a> grants are the only Authorization Flows
recommended by farmOS for use with 3rd party clients.</p>
<p><strong>NOTE:</strong> Only use the <strong>Password Grant</strong> if the client can be trusted with a
farmOS username and password (this is considered <em>1st party</em>). The
<strong>Client Credentials Grant</strong> is often used for machine authentication not
associated with a user account. Due to limitations with the Drupal 7
<a href="https://www.drupal.org/project/oauth2_server">oauth2_server</a> module, access tokens provided via the Client Credentials Grant
cannot be associated with the Drupal Permissions system to access protected
resources. farmOS will hopefully support the Client Credentials Grant when
farmOS migrates to Drupal 8 and can use the <a href="https://www.drupal.org/project/simple_oauth/">simple_oauth</a> module.</p>
<p><strong>NOTE:</strong> The <code>oauth2/token</code> and <code>oauth2/authorize</code> endpoints are deprecated and
will be removed in farmOS 2.x. Starting with farmOS 1.6 it is recommended to use
the new <code>oauth/token</code> and <code>oauth/authorize</code> endpoints.</p>
<h4 id="authorization-code-grant">Authorization Code Grant<a class="headerlink" href="#authorization-code-grant" title="Permanent link">&para;</a></h4>
<p>The Authorization Code Grant is most popular for 3rd party client authorization.</p>
<p>Requesting resources is a four step process:</p>
<p><strong>First</strong>: the client sends a request to the farmOS server <code>/oauth/authorize</code>
endpoint requesting an <code>Authorization Code</code>. The user logs in and authorizes
the client to have the OAuth Scopes it is requesting.</p>
<pre><code>Copy this link to browser -
http://localhost/oauth/authorize?response_type=code&amp;client_id=farmos_development&amp;scope=user_access&amp;redirect_uri=http://localhost/api/authorized&amp;state=p4W8P5f7gJCIDbC1Mv78zHhlpJOidy
</code></pre>
<p><strong>Second</strong>: after the user accepts, the server redirects
to the <code>redirect_uri</code> with an authorization <code>code</code> and <code>state</code> in the query
parameters.</p>
<pre><code>Example redirect url from server:
http://localhost/api/authorized?code=9eb9442c7a2b011fd59617635cca5421cd089943&amp;state=p4W8P5f7gJCIDbC1Mv78zHhlpJOidy
</code></pre>
<p><strong>Third</strong>: copy the <code>code</code> and <code>state</code> from the URL into the body of a POST request.
The <code>grant_type</code>, <code>client_id</code>, <code>client_secret</code> and <code>redirect_uri</code> must also be
included in the POST body. The client makes a POST request to the
<code>/oauth/token</code> endpoint to retrieve an <code>access_token</code> and <code>refresh_token</code>.</p>
<pre><code>foo@bar:~$ curl -X POST -d "grant_type=authorization_code&amp;code=ae4d1381cc67def1c10dc88a19af6ac30d7b5959&amp;client_id=farmos_development&amp;redirect_uri=http://localhost/api/authorized" http://localhost/oauth/token
{"access_token":"3f9212c4a6656f1cd1304e47307927a7c224abb0","expires_in":"10","token_type":"Bearer","scope":"user_access","refresh_token":"292810b04d688bfb5c3cee28e45637ec8ef1dd9e"}
</code></pre>
<p><strong>Fourth</strong>: the client sends the access token in the request header to access protected
resources. The header is an Authorization header with a Bearer token: 
 <code>Authorization: Bearer access_token</code></p>
<pre><code>foo@bar:~$ curl --header "Authorization: Bearer b872daf5827a75495c8194c6bfa4f90cf46c143e" http://localhost/farm.json
{"name":"farmos-server","url":"http:\/\/localhost","api_version":"1.1","user":{"uid":"1","name":"admin", ....
</code></pre>
<h4 id="password-credentials-grant">Password Credentials Grant<a class="headerlink" href="#password-credentials-grant" title="Permanent link">&para;</a></h4>
<p><strong>NOTE:</strong> Only use the <strong>Password Grant</strong> if the client can be trusted with a
farmOS username and password (this is considered <em>1st party</em>).</p>
<p>The Password Credentials Grant uses a farmOS <code>username</code> and <code>password</code> to 
retrieve an <code>access_token</code> and <code>refresh_token</code> in one step. For the user, this
is the simplest type of <em>authorization.</em> Because the client can be trusted with
their farmOS Credentials, a users <code>username</code> and <code>password</code> can be collected
directly into a login form within the client application. These credentials are
then used (not stored) to request tokens which are used for <em>authentication</em> 
with the farmOS server and retrieving data.</p>
<p>Requesting protected resources is a two step process:</p>
<p><strong>First</strong>, the client sends a POST request to the farmOS server <code>/oauth/token</code>
endpoint with <code>grant_type</code> set to <code>password</code> and a <code>username</code> and <code>password</code>
included in the request body.</p>
<pre><code>$ curl -X POST -d "grant_type=password&amp;username=username&amp;password=test&amp;client_id=farm&amp;scope=user_access" http://localhost/oauth/token
{"access_token":"e69c60dea3f5c59c95863928fa6fb860d3506fe9","expires_in":"300","token_type":"Bearer","scope":"user_access","refresh_token":"cead7d46d18d74daea83f114bc0b512ec4cc31c3"}
</code></pre>
<p><strong>second</strong>, the client sends the <code>access_token</code> in the request header to access protected
resources. The header is an Authorization header with a Bearer token: 
 <code>Authorization: Bearer access_token</code></p>
<pre><code>foo@bar:~$ curl --header "Authorization: Bearer e69c60dea3f5c59c95863928fa6fb860d3506fe9" http://localhost/farm.json
{"name":"farmos-server","url":"http:\/\/localhost","api_version":"1.1","user":{"uid":"1","name":"admin", ....
</code></pre>
<h4 id="refreshing-tokens">Refreshing Tokens<a class="headerlink" href="#refreshing-tokens" title="Permanent link">&para;</a></h4>
<p>The <code>refresh_token</code> can be used to retrieve a new <code>access_token</code> if the token
has expired.</p>
<p>It is a one step process:</p>
<p>The client sends an authenticated request to the <code>/oauth/token</code>endpoint with
<code>grant_type</code> set to <code>refresh_token</code> and includes the <code>refresh_token</code>,
<code>client_id</code> and <code>client_secret</code> in the request body.</p>
<pre><code>foo@bar:~$ curl -X POST -H 'Authorization: Bearer ad52c04d26c1002084501d28b59196996f0bd93f' -d 'refresh_token=52e7a0e12e8ddd08b155b3b3ee385687fef01664&amp;grant_type=refresh_token&amp;client_id=farmos_api_client&amp;client_secret=client_secret' http://localhost/oauth/token
{"access_token":"acdbfabb736e42aa301b50fdda95d6b7fd3e7e14","expires_in":"300","token_type":"Bearer","scope":"user_access","refresh_token":"b73f4744840498a26f43447d8cf755238bfd391a"}
</code></pre>
<p>The server responds with an <code>access_token</code> and <code>refresh_token</code> that can be used
in future requests. The previous <code>access_token</code> and <code>refresh_token</code> will no
longer work.</p>
<h3 id="oauth2-authorization-with-the-farmos-api">OAuth2 Authorization with the farmOS API<a class="headerlink" href="#oauth2-authorization-with-the-farmos-api" title="Permanent link">&para;</a></h3>
<h4 id="authorization-in-farmospy">Authorization in farmOS.py<a class="headerlink" href="#authorization-in-farmospy" title="Permanent link">&para;</a></h4>
<p>Support for OAuth was added to <a href="https://github.com/farmOS/farmOS.py">farmOS.py</a> starting with v0.1.6. To authorize
and authenticate via OAuth, just supply the required parameters when creating
a client. The library will know to use an OAuth Password Credentials or 
Authorization Code flow.</p>
<h5 id="password-credentials-flow">Password Credentials Flow:<a class="headerlink" href="#password-credentials-flow" title="Permanent link">&para;</a></h5>
<pre><code>farm_client = farmOS(
    hostname=url,
    username=farmos_username,
    password=farmos_password,
    client_id="farm",
    scope="user_access",
    # Supply a profile name so the tokens are saved to config
    profile_name="farm"
)
</code></pre>
<p>Running from a Python Console, the <code>password</code> can also be omitted and entered
at runtime. This allows testing without saving a password in plaintext:</p>
<pre><code>&gt;&gt;&gt; from farmOS import farmOS
&gt;&gt;&gt; farm_client = farmOS(hostname="http://localhost", username=farmos_username, client_id="farm", scope="user_access")
&gt;&gt;&gt; Warning: Password input may be echoed.
&gt;&gt;&gt; Enter password: &gt;? MY_PASSWORD
&gt;&gt;&gt; farm_client.info()
'name': 'server-name', 'url': 'http://localhost', 'api_version': '1.2', 'user': ....
</code></pre>
<h5 id="authorization-code-flow">Authorization Code Flow:<a class="headerlink" href="#authorization-code-flow" title="Permanent link">&para;</a></h5>
<p>It's also possible to run the Authorization Code Flow from the Python console.
This is great way to test the Authorization process users will go through. The
console will print a link to navigate to where you sign in to farmOS and 
complete the authorization process. You then copy the <code>link</code> from the page you
are redirected to back into the console. This supplies the <code>farm_client</code> with
an an authorization <code>code</code> that it uses to request an OAuth <code>token</code>. </p>
<pre><code>&gt;&gt;&gt; farm_client = farmOS(hostname="http://localhost", client_id="farmos_development", scope="user_access")
Please go here and authorize, http://localhost/oauth/authorize?response_type=code&amp;client_id=farmos_development&amp;redirect_uri=http%3A%2F%2Flocalhost%2Fapi%2Fauthorized&amp;scope=user_access&amp;state=V9RCDd4yrSWZP8iGXt6qW51sYxsFZs&amp;access_type=offline&amp;prompt=select_account
Paste the full redirect URL here:&gt;? http://localhost/api/authorized?code=33429f3530e36f4bdf3c2adbbfcd5b7d73e89d5c&amp;state=V9RCDd4yrSWZP8iGXt6qW51sYxsFZs

&gt;&gt;&gt; farm_client.info()
'name': 'server-name', 'url': 'http://localhost', 'api_version': '1.2', 'user': ....
</code></pre>
<h5 id="supplying-an-existing-token">Supplying an existing token:<a class="headerlink" href="#supplying-an-existing-token" title="Permanent link">&para;</a></h5>
<p>It can also be useful to create a client with an existing OAuth Token. This is
possible by supplying the <code>token</code> parameter:</p>
<pre><code>token = {
    'access_token': "token",
    'refresh_token': "token",
}

farm_client = farmOS(
    hostname=url,
    client_id=client_id,
    client_secret=client_secret,
    scope=scope,
    token=token,
)
</code></pre>
<p>This is how the <a href="https://github.com/farmOS/farmOS-aggregator">farmOS Aggregator</a> uses <a href="https://github.com/farmOS/farmOS.py">farmOS.py</a> to communicate with farmOS
servers. OAuth tokens are stored in the Aggregator's database instead of
usernames and passwords. See how this is implemented in code 
<a href="https://github.com/farmOS/farmOS-aggregator/blob/master/backend/app/app/api/utils/farms.py#L195">here</a></p>
<h2 id="troubleshooting">Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permanent link">&para;</a></h2>
<p>Some common issues and solutions are described below. If these do not help,
submit a support request on <a href="https://github.com/farmOS/farmOS">GitHub</a> or ask questions in the
<a href="https://riot.im/app/#/room/#farmOS:matrix.org">farmOS chat room</a>.</p>
<ul>
<li><strong>HTTPS redirects</strong> - If your farmOS instance automatically redirects from
  <code>http://</code> to <code>https://</code>, make sure you are making requests using the
  <code>https://</code> protocol. The redirect can cause issues with some API requests.</li>
<li><strong>Date format</strong> - All dates in farmOS are stored in <a href="https://en.wikipedia.org/wiki/Unix_time">Unix timestamp</a> format.
  Most frameworks/languages provide functions for generating/converting
  dates/times to this format. Only Unix timestamps will be accepted by the API.</li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p><p><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">farmOS.org</span> content is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.<br />farmOS is a <a href="/community/trademark">registered trademark</a> of <a href="http://mstenta.net">Michael Stenta</a></p><p><a href="/donate">Donate</a> to help support the farmOS project.</p>.</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../deprecated.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
